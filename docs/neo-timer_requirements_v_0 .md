# 心理学アプローチ・ポモドーロタイマー｜基本要件定義書 v0.3（PWA MVP版／ガードレール確定）

- 作成日: 2025-08-09
- 作成者: （あなたの名前）
- 版数: v0.3（開発エージェント向け・目的/スコープの明確化版）
- 対象: Coding Agent（Cursor / Claude Code 等）および人間開発者

> 本ドキュメントは **開発エージェントが暴走しないためのガードレール** を主目的とします。実装の詳細は“推奨案”として示し、**代替案の提案を歓迎**します。

---

## 0. 目的と背景

- **目的**: ポモドーロを心理学の実践知で強化し、**始めやすく（開始摩擦の低減）／続けやすく（即時報酬）／振り返りやすい（記録と簡易統計）** PWA を提供する。
- **背景**: 25/5固定では個人差にフィットしづらい。まずは**最小の行動（3分ウォームアップ）**と**記録**に集中し、将来的に個別最適や外部連携に拡張する。
- **ロードマップ方針**: PWA最小値（MVP） → 個別学習・価値可視化（v1.5） → 拡張/ウェアラブル等の外部連携（v2）。

---

## 1. ガードレール（目的・非目的・意思決定原則）

### 1.1 目的（MVPの価値）

- **開始摩擦の低減**: 3分ウォームアップで“とりあえず始める”。
- **即時報酬**: セッション完了時の肯定的フィードバック。
- **記録と可視化**: 日/週の合計時間・完了数の**簡易**統計。

### 1.2 非目的（MVPでやらないこと）

- 強制的なサイトブロックや過度な監視。
- バックグラウンドでの確実通知（Push/拡張依存）。
- 生体センシング（HRV等）、チーム機能、課金、必須アカウント。

### 1.3 意思決定原則

- **自律尊重**: 介入は“提案止まり”。常にユーザーの veto を優先。
- **ローカル優先**: 既定は端末内で完結。同期や送信は明示同意でON。
- **最小実装→検証**: 値やコピーは**実験フラグ**で変更可能に。
- **最小権限**: 権限/通知は段階的に依頼。不要な権限は要求しない。
- **透明性**: 仕様の推測変更は不可。不明点は**質問一覧**で提示。

---

## 2. スコープ / 非スコープ / 将来

**スコープ（MVP / 本版の対象）**

- Vercelで公開可能な **Next.js + TypeScript + Tailwind の PWA**。
- 完全オフライン動作（IndexedDB/Dexie）。
- 機能: 可変タイマー／3分ウォームアップ／達成フィードバック／履歴・簡易統計／気分タグ（開始/終了）／**フォアグラウンド通知のみ**。

**非スコープ（MVP）**

- フロー自動延長や早め休憩の**自動提案**（S2以降）。
- バックグラウンド通知（Push/拡張）。サイトブロック。生体連携。チーム・課金。

**将来スコープ（方向性のみ）**

- **v1.5**: 個別最適サイクル提案、時間→金額の価値ダッシュボード、コピーA/B。
- **v2**: Chrome拡張（薄いセンサー: `alarms/notifications`→同意で`tabs/idle`段階開放）、ウェアラブル連携、任意のクラウド同期（Supabase/Vercel DB）。

---

## 3. ペルソナ / ユースケース

- **ペルソナ**: 個人開発者・知的労働者（30–50代、Windows/Chrome中心）。開始時の抵抗が高い。
- **ユースケース（MVP）**
  1. 起動 → **ウォームアップ3分** → 25–40分作業 → 5分休憩。
  2. 終了後に短い肯定メッセージで即時報酬。
  3. 1日の作業合計と完了数を確認（翌日の着手に活用）。

---

## 4. 成功指標（KPI と計測方針）

- **D1継続率 ≥ 45%**（初回起動→翌日再来率）。※**β以降**に匿名同意を得たユーザーのみ集計。
- **セッション平均長 +12%**（v1.5導入後3か月、ローカル比較）。
- **感情リセット時間 −20%**（終了時mood→5分後moodの差分、ローカル推計）。
  > 計測段階: **MVP=ローカルのみ**、**β=匿名分析（同意必須）**。保持期間/項目はプライバシー章を遵守。

---

## 5. PWA MVP 要件（高レベル）

### 5.1 機能要件（MVP）

- 可変タイマー（作業/休憩プリセットの調整）。
- **ウォームアップ3分**（スキップで即通常開始）。
- セッション保存/復帰（強制終了時は続行 or 破棄を選択）。
- 達成フィードバック（短文トースト、i18n）。
- 履歴・簡易統計（合計時間・完了数・達成率）。
- 気分タグ（開始/終了のワンタップ）。
- 通知: **フォアグラウンド通知のみ**（権限依頼は達成体験後）。

### 5.2 非機能要件（MVP）

- レイテンシ: UI反応 <100ms / 設定保存 <200ms（目安）。
- オフライン: タイマー・履歴の完全動作。
- A11y: WCAG 2.2 AA相当。キーボード完結、フォーカス可視。
- 安定性: β期間の致命エラー率 <0.5%。
- プライバシー: 既定ローカル保存。同期/送信は明示同意でON。

---

## 6. 設計方針（推奨案／拘束しない）

> ここに記すのは **推奨実装** です。エージェントは**代替案とトレードオフ**を添えて提案可能です。

### 6.1 タイマー（推奨）

- 真の経過時間は `remaining = Math.max(0, targetAt - Date.now())` をSoTとする。
- 可視時は `requestAnimationFrame` でUI更新。不可視時は更新しないが復帰時に差分再計算。
- 端末時刻変更やスリープ復帰は、差分の乖離を検知して案内（例: 再同期メッセージ）。

### 6.2 データモデル（MVP）

- `Session { id, startAt, endAt, focusMs, breakMs, flowExtended?:boolean, moodStart?:Mood, moodEnd?:Mood, taskNote?:string }`
- `UserPref { focusPresetMs, breakPresetMs, warmupEnabled:boolean, hourlyValue?:number, locale, privacyLevel }`
- `TimerState { mode:"warmup"|"focus"|"break"|"idle", startedAt?:number, targetAt?:number, pausedAt?:number }`
- **索引**: `Session.startAt` に日付/週集計を意識したインデックスを付与。
- ※ `SuggestionLog` 等の自動提案系は **S2以降** に定義。

### 6.3 PWA/オフライン

- `manifest.webmanifest` と `sw.js`。静的: Cache First、HTML: Network First（fallback: cache）。
- **navigate fallback**: オフライン時は全ルートを index へフォールバック。
- 更新適用: 作業中は通知のみ。**カウント中は自動更新しない**（終了後に適用）。

### 6.4 エラー処理

- 強制終了時に `TimerState` を永続化し、起動時復帰ダイアログ。
- DBマイグレーションはDexieのスキーマバージョンで実施。

### 6.5 テレメトリ/データ保護（段階導入）

- **MVP**: ローカルのみ。エクスポート/全削除は **S2** で提供。
- **β**: 同意ユーザーに限り匿名イベント送信（保持期間と項目を明記）。

---

## 7. 実装タスク（S1/S2）※参考の割付例であり、代替案歓迎

### S1: MVP基盤（例）

- S1-01: プロジェクト雛形 & Lint/Format/CI。
- S1-02: PWA最小実装（manifest / sw.js）。
- S1-03: Dexieスキーマ v1（`Session/UserPref/TimerState`）。
- S1-04: Zustand ストア（timer/session/ui）。
- S1-05: タイマーエンジン（差分再計算方式）。
- S1-06: Home画面（タイマーUI/操作）。
- S1-07: ウォームアップ3分（スキップ→通常）。
- S1-08: セッション保存/復帰（TimerState連携）。
- S1-09: 達成フィードバック（短文トースト/i18n）。
- S1-10: テスト基盤（Jest/Playwright）。
- S1-11: A11y基盤（重大Issue 0）。
- S1-12: ドキュメント整備（CONTRIBUTING/DEVELOPMENT）。

### S2: 体験強化（例・高粒度エピック）

- Stats強化（期間フィルタ/トレンド）。
- Settings拡充（既定値・トグル・ロケール）。
- 通知導線の最適化（許可依頼のタイミング）。
- 文面A/Bの仕組み（実験フラグ）。
- 自動提案の基盤定義（ログ/ヒューリスティック）※実装はS3以降でも可。
- データポータビリティ（エクスポート/全削除）。

---

## 8. 品質保証（MVP）

- **テスト**: 単体（タイマー・ストア・DB）、E2E（開始→一時停止→再開→完了、復帰）。
- **受入基準（抜粋）**
  - 起動→開始が**2操作以内**で可能。
  - ウォームアップはスキップ可能で、即通常セッションへ。
  - 強制終了後、次回起動時に**続行/破棄**を選べる。
  - オフラインでもHomeが開け、記録が保存される。

---

## 9. デプロイ/運用（Vercel）

- GitHub連携→Import→標準Build。ドメインは任意。
- PWA更新は**作業中に適用しない**。完了後の再読み込み案内で適用。
- Cron/サーバ機能はMVPでは未使用。

---

## 10. 今後の方針展開（概要）

- **v1.5**: 個別最適（簡易ML or ルール）／価値ダッシュボード（時給設定→日/週合計）／コピーA/B。
- **v2**: PWA=UI/学習、拡張=センサー（`alarms`→同意で`tabs/idle`）。**段階的権限**を明記。Pushやサイトブロックは**提案優先**で、強制は実験フラグ下。
- **同期/バックエンド**: 任意採用（Supabase/Vercel DB）。RLS/最小データ。
- **ウェアラブル**: 明示同意の上、推奨のみ（自動強制は行わない）。

---

## 11. 決定ログ（v0.3）

- バックグラウンド通知はMVPでは扱わない（Foregroundのみ）。
- フロー自動延長・早め休憩は**S2以降**へ移管。
- テレメトリは段階導入（MVP=ローカル／β=匿名同意）。
- 作業中はアプリ更新を適用しない。

---

## 12. Open Questions（エージェントの最初の質問票）

1. ウォームアップ既定値（3分）の上限/下限は？（例: 1–5分）
2. 休憩の既定値は 5分固定か、比率ベースか？
3. 週の起点（統計）は月曜/日曜のどちらに合わせるか？
4. 達成トーストの文調（敬体/常体）と最大文字数の指針は？
5. PWAのアイコン/名称/短縮名の正式案は？

---

## 13. エージェント協働ルール（簡潔）

- 仕様の推測変更は禁止。疑問は**質問一覧**として先に提示。
- PRは**300行以下**を目安。実装/テスト/Docsを同梱。
- 代替案は**2案まで**＋トレードオフを簡潔に記載。
- 危険コマンド・大域的リファクタ・依存追加は**事前合意なし禁止**。

---

### 付録A: 受け入れ基準（例）

- **US-001**（ウォームアップ）
  - Given 起動、When `開始`、Then 3分カウント開始。
  - Given カウント中、When `スキップ`、Then 即通常へ遷移。
  - Given 通常、When 残0、Then 完了トースト表示 & 履歴保存。

### 付録B: UIモック（テキスト）

- `Home`: 残り時間、開始/一時停止/スキップ、ウォームアップカード、気分タグ。
- `Stats`: 日/週/月の時間、完了数、達成率（将来: 価値換算）。
- `Settings`: プリセット、ウォームアップ、通知、実験トグル、ロケール。

### 付録C: プライバシー通知（草案）

- 既定はローカル保存のみ。同期/送信は同意でON、撤回はいつでも可能。

### 付録D: 工学目標（指標であって必須要件ではない）

- 初回描画 <1.2s（デスクトップ常時回線の参考値）。
- タイマー表示の体感滑らかさ（可視時は`rAF`更新）。
- Axe 自動検査の重大問題 0。
